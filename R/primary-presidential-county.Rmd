---
title: Parse the primary, presidential elections at county level
author: Duncan Garmonsway
output: html_document
---

First, run /R/download.R to download the source files.

```{r, echo = TRUE}
library(tidyverse)
library(stringr)
library(stringi)
library(tidyxl)
library(unpivotr)
library(here)

sources_path <- here("sources")
output_path <- here("output")
xlsx_dir <- here("xlsx")
csv_dir <- here("csv")
idaho_home <- "http://www.sos.idaho.gov/ELECT/results/"
idaho_url <- paste0(idaho_home, "index.html")
url_table_path <- file.path(sources_path, "url-table.html")
working_dir <- here("working")
files_path <- file.path(working_dir, "files.csv")
county_files_path <- file.path(working_dir, "county_files.csv")
```

The various kinds of files to work with.  This script handles statewide,
primary, county.  The numbers are the number of files of the given kind.

```{r, echo = TRUE}
files <- read_csv(files_path)
files %>%
  select(scope, election, geography) %>%
  ftable(row.vars = 1:2, col.vars = 3)
```

```{r, echo = TRUE}
table_votes <- function(cells, name) {
  cat("sheet: ", name, "\n")
  counties <-
    cells %>%
    filter(col == 1, str_trim(tolower(character)) == "counties")
  party <-
    cells %>%
    filter(row == counties$row - 1, col != 1, !is.na(character)) %>%
    mutate(party = str_trim(character)) %>%
    select(row, col, party)
  candidate <-
    cells %>%
    filter(row == counties$row, col != 1, !is.na(character)) %>%
    mutate(candidate = str_trim(character)) %>%
    select(row, col, candidate)
  county <-
    counties %>%
    offset_S(cells, 1) %>%
    extend_S(cells, boundary = ~ str_trim(tolower(character)) == "total") %>%
    mutate(county = str_trim(character)) %>%
    select(row, col, county)
  votes <-
    cells %>%
    filter(col != 1, row > counties$row, !is.na(numeric)) %>%
    semi_join(county, by = "row") %>%
    semi_join(party, by = "col") %>%
    mutate(votes = numeric) %>%
    select(row, col, votes)
  votes %>%
    W(county) %>%
    N(party) %>%
    N(candidate) %>%
    select(county, party, candidate, votes)
}
```

A function to iterate over all the sheets in a workbook.

```{r, echo = TRUE}
book_votes <- function(x) {
  cat("book: ", x, "\n")
  x <- tidy_xlsx(x)
  map2_df(x$data,
          str_trim(tolower(names(x$data))),
          table_votes, .id = "sheet")
}
```

Apply the above functions to every presidential, primary, county file.

```{r, echo = TRUE}
votes <-
  files %>%
  filter(scope == "statewide presidential",
         election == "primary",
         geography == "county") %>%
  pull(xlsx_path) %>%
  set_names(.) %>%
  map_df(book_votes, .id = "book")
```

Check the data quality by listing unique values in each field.

```{r, echo = TRUE}
votes %>%
  select(-votes) %>%
  map(~ .x %>%
      str_replace("\\n", " ") %>%
      str_trim() %>%
      table())
```

Write to output file.

```{r, echo = TRUE}
votes %>%
  write_csv(file.path(output_path,
                      "yyyymmdd__id__primary__county__presidential.csv"))
```
